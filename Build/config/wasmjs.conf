X4C_ARCH  := wasmjs
X4C_BUILD := emscripten

X4C_CC    ?= emcc
X4C_CXX   ?= em++
X4C_AR    ?= emar
X4C_LD    ?= em++
X4C_ASM	  ?= emcc ## N/A ...
X4C_RANDLIB ?= emranlib

DLLEXT := .wasm
EXEEXT := .html

X4C_RELEASE_CFLAGS   ?= -Os -g -DNDEBUG
X4C_RELEASE_CXXFLAGS ?= -Os -g -DNDEBUG

ifeq ("$(E)","1")
X4C_TOOLCHAIN_CFLAGS	?= -Wall -Werror
X4C_TOOLCHAIN_CXXFLAGS	?= -Wall -Werror
else
X4C_TOOLCHAIN_CFLAGS	?= -Wall
X4C_TOOLCHAIN_CXXFLAGS	?= -Wall
endif

ifeq ("$(R)$(BT)","10")
X4C_TOOLCHAIN_CFLAGS	+= -fomit-frame-pointer
X4C_TOOLCHAIN_CXXFLAGS	+= -fomit-frame-pointer
endif

X4C_TOOLCHAIN_CFLAGS     += -ffunction-sections -fdata-sections -fvisibility=hidden
X4C_TOOLCHAIN_CXXFLAGS   += -ffunction-sections -fdata-sections -fvisibility=hidden -fvisibility-inlines-hidden
X4C_TOOLCHAIN_LDFLAGS    += -s WASM=1 -s EXPORT_ES6=1 -s MODULARIZE=1 

define x4c-cmd-ar
$2 : $$($(strip $1))
	$$(hide) $$(info AR $$@)
	$$(hide) $$(X4C_AR) $$($(strip $3)) cr $$@ $$($(strip $1))
	$$(hide) $$(X4C_RANDLIB) $$@
endef

define x4c-cmd-ld
$2 : $$($(strip $1))
	$$(info LD $$@)
	$$(hide) $$(X4C_LD) -o $$@ $$($(strip $1)) $$($(strip $3)) $$(LIBX4C_EXT_LDFLAGS)
endef

#
#   ldso <input> <output> <ldflags>
#
ifeq ("$(origin x4c-cmd-ldso)","undefined")
define x4c-cmd-ldso
$2 : $$($(strip $1))
	$$(info LDSO $$@)
	$$(hide) $$(X4C_LD) -o $$@ $$($(strip $1)) $$($(strip $3))	$$(LIBX4C_EXT_LDFLAGS) -Wl,--no-entry
endef
endif

#
#	intstall-executable		<input>		<output>
#
ifeq ("$(origin x4c-cmd-intstall-executable)","undefined")
define x4c-cmd-intstall-executable
$2 : $1
	$$(info INSTALL $$@)
	$$(hide) if [ -f $$(call basename,$$<).js        ] ; then install $$(call basename,$$<).js $$(call dir,$$@);        fi
	$$(hide) if [ -f $$(call basename,$$<).wasm      ] ; then install $$(call basename,$$<).wasm $$(call dir,$$@);      fi
	$$(hide) if [ -f $$(call basename,$$<).html      ] ; then install $$(call basename,$$<).html $$(call dir,$$@);      fi
	$$(hide) if [ -f $$(call basename,$$<).worker.js ] ; then install $$(call basename,$$<).worker.js $$(call dir,$$@); fi
endef
endif
