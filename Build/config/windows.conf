
##
##  amd64-windows (default) || i686-windows ...
##

X4C_ARCH  ?= amd64
X4C_BUILD := windows

ifneq ("$(X4C_ARCH)","amd64")
X4C_ARCH  := i686
endif

X4C_CC     ?= cl.exe
X4C_CXX	   ?= cl.exe 
X4C_AR     ?= lib.exe
X4C_LD	   ?= link.exe
X4C_DEP_CC  ?= gcc
X4C_DEP_CXX ?= g++

##
##
##
LIBEXT := .lib
DLLEXT := .dll
EXEEXT := .exe

X4C_TOOLCHAIN_LDFLAGS	?= -nologo -debug
X4C_TOOLCHAIN_ASLAGS    ?=

X4C_MSVCSPEC_CFLAGS		?= $(X4C_MSVCSPEC_USER_CFLAGS) -nologo -FS

ifeq ("$(E)","1")
X4C_MSVCSPEC_CFLAGS		+= -WX
endif

##
##
##
X4C_MSVCSPEC_CFLAGS		+= -Zi -openmp

##
##
##
ifeq ("$(X4C_ARCH)","amd64")
X4C_ASM   ?= nasm -f win64 -g
else
X4C_ASM   ?= nasm -f win32 -g
endif

ifeq ("$(R)$(BT)","10")
X4C_MSVCSPEC_OPT_CFLAGS		?= -O2 -Ob2 -Oy
else
X4C_MSVCSPEC_OPT_CFLAGS		?= -O2 -Ob2 -Oy-
endif

X4C_MSVCSPEC_CFLAGS_DBG		?= -D_DEBUG -MDd -RTC1 -Od
X4C_MSVCSPEC_CFLAGS_RLS		?= -DNDEBUG $(X4C_MSVCSPEC_OPT_CFLAGS) -MD

ifeq ("$(R)","1")
X4C_MSVCSPEC_CFLAGS			+= $(X4C_MSVCSPEC_CFLAGS_RLS)
else
X4C_MSVCSPEC_CFLAGS			+= $(X4C_MSVCSPEC_CFLAGS_DBG)
endif

##
##
##
X4C_MSVCSPEC_CFLAGS_CC		?= -W4
X4C_MSVCSPEC_CFLAGS_CXX		?= -EHsc -W3

##
##
##
X4C_RELEASE_CFLAGS   ?= -DNDEBUG
X4C_RELEASE_CXXFLAGS ?= -DNDEBUG
X4C_DEBUG_CFLAGS     ?= -D_DEBUG
X4C_DEBUG_CXXFLAGS   ?= -D_DEBUG


#
#	cc    <input> <output> <dep-file> <cflags>
#
define x4c-cmd-cc
$2 : $1 
	$$(hide) $$(info CC $1)
	$$(hide) $$(X4C_CC) $$(X4C_MSVCSPEC_CFLAGS) $$(X4C_MSVCSPEC_CFLAGS_CC) $$($(strip $4)) -Fd"$(x4c_MODULE_OUTPUT)/$(LOCAL_MODULE).pdb" -c -Fo"$$@" $$<
	$$(hide) $$(X4C_DEP_CC) $$($(strip $4)) -MM -MT $$@ -MF $3 $$< || exit 0
endef

#
#	cxx  <input> <output> <dep-file> <cxxflags>
#
define x4c-cmd-cxx
$2 : $1
	$$(hide) $$(info CXX $1)
	$$(hide) $$(X4C_CC) $$(X4C_MSVCSPEC_CFLAGS) $$(X4C_MSVCSPEC_CFLAGS_CXX) $$($(strip $4)) -Fd"$(x4c_MODULE_OUTPUT)/$(LOCAL_MODULE).pdb" -c -Fo"$$@" $$<
	$$(hide) $$(X4C_DEP_CXX) $$($(strip $4)) -MM -MT $$@ -MF $3 $$< || exit 0
endef

#
#   ar <input-varname> <output> <arflags>
#
ifeq ("$(origin x4c-cmd-ar)","undefined")
define x4c-cmd-ar
$2 : $$($(strip $1))
	$$(hide) $$(info AR $$@)
	$$(hide) $$(X4C_AR) -nologo $$($(strip $3)) -out:$$@ $$($(strip $1))
endef
endif

#
#   ld <input> <output> <ldflags>
#
ifeq ("$(origin x4c-cmd-ld)","undefined")
define x4c-cmd-ld
$2 : $$($(strip $1))
	$$(info LD $$@)
	$$(hide) $$(X4C_LD) $$($(strip $3)) $$(LIBX4C_EXT_LDFLAGS) -pdb:"$(x4c_MODULE_OUTPUT)/$(LOCAL_MODULE).pdb" -out:$$@ $$($(strip $1)) 
endef
endif

#
#   ldso <input> <output> <ldflags>
#
ifeq ("$(origin x4c-cmd-ldso)","undefined")
define x4c-cmd-ldso
$2 : $$($(strip $1))
	$$(info LDSO $$@)
	$$(hide) $$(X4C_LD) -dll $$($(strip $3)) $$(LIBX4C_EXT_LDFLAGS) -pdb:"$(x4c_MODULE_OUTPUT)/$(LOCAL_MODULE).pdb" -out:$$@ $$($(strip $1)) 
endef
endif

#
#	ldflags-add-dir  <varname>  <dir...>
#
ifeq ("$(origin x4c-cmd-ldflags-add-dir)","undefined")
define x4c-cmd-ldflags-add-dir
	$(eval $1 += $(addprefix -libpath:,$2) )
endef
endif

#
#	ldflags-add-static-module  <varname>	<modules...>
#
ifeq ("$(origin x4c-cmd-ldflags-add-static-module)","undefined")
define x4c-cmd-ldflags-add-static-module	
	$(eval $1 += $(addprefix lib,$(addsuffix .lib,$2)) )	
endef
endif

#
#	ldflags-add-shared-module  <varname>	<modules...>
#
ifeq ("$(origin x4c-cmd-ldflags-add-shared-module)","undefined")
define x4c-cmd-ldflags-add-shared-module
	$(eval $1 += $(addprefix lib,$(addsuffix .lib,$2)) )
endef
endif


#
#	intstall-shared-lib		<input>		<output>
#
ifeq ("$(origin x4c-cmd-intstall-shared-lib)","undefined")
define x4c-cmd-intstall-shared-lib
$2 : $1
	$$(info INSTALL $2)
	$$(hide) cp $$<* $(call dir,$2)
endef
endif

#
#	intstall-executable		<input>		<output>
#
ifeq ("$(origin x4c-cmd-intstall-executable)","undefined")
define x4c-cmd-intstall-executable	
$2 : $1
	$$(info INSTALL $2)
	$$(hide) cp $$<* $(call dir,$2)
endef
endif
